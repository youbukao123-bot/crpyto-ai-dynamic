# 钉钉通知功能使用说明

## 🔔 功能概述

在线交易系统现已集成钉钉通知功能，能够实时推送各种交易相关的通知到钉钉群聊，让你随时掌握交易状态。

## 📋 通知类型

### 1. 交易操作通知
- **开仓通知**: 当系统开设新仓位时发送，包含交易对、价格、数量、投资金额、策略类型、信号强度等信息
- **平仓通知**: 当系统平仓时发送，包含盈亏情况、平仓原因、持仓时长等详细信息
- **挂单通知**: 当系统下挂单时发送，包含挂单价格、数量、策略类型等信息
- **挂单成交通知**: 当挂单成交时发送
- **挂单取消通知**: 当挂单被取消时发送（包括超时、手动取消等）

### 2. 系统监控通知
- **风险警报**: 当检测到风险事件时发送（如仓位过高、连续亏损等）
- **系统状态通知**: 系统启动、停止、异常等状态变化
- **投资组合摘要**: 定期发送账户总览信息

## 🚀 使用方法

### 启动交易系统时启用钉钉通知

```bash
# 使用默认配置启动（已包含钉钉通知）
python3 start_online_trading.py

# 指定自定义webhook地址
python3 start_online_trading.py --dingtalk-webhook "你的webhook地址"

# 禁用钉钉通知
python3 start_online_trading.py --disable-dingtalk

# 仅启动策略引擎并启用通知
python3 start_online_trading.py --strategy-only
```

### 配置说明

#### Webhook地址
当前使用的钉钉机器人Webhook地址：
```
https://oapi.dingtalk.com/robot/send?access_token=562f41c37f10bc9d77fb0e3535c1cc778e7666ad9c1173fffcf9fb8a939118a7
```

#### 关键词要求
钉钉机器人要求消息中必须包含关键词 **"Code"**，系统已自动处理此要求。

## 📝 通知示例

### 开仓通知示例
```
# 🚀 开仓通知

**交易对**: BTCUSDT
**开仓时间**: 2024-09-14 15:30:25
**开仓价格**: $65432.10
**开仓数量**: 0.001523
**投资金额**: $99.65
**策略类型**: volume_breakout
**信号强度**: 7.5

**开仓理由**: 成交量突破信号，信号强度7.5，使用限价单

---
*系统自动通知*
```

### 平仓通知示例
```
# 🎉 平仓通知

**交易对**: BTCUSDT
**平仓时间**: 2024-09-14 18:45:30
**平仓价格**: $67123.45
**平仓数量**: 0.001523
**平仓收入**: $102.24
**原始成本**: $99.65
**盈亏金额**: +$2.59
**盈亏比例**: +2.6%
**持仓时长**: 12.5小时

**平仓原因**: 移动止盈 (2.6%)

---
*系统自动通知*
```

## 🔧 技术实现

### 核心组件
- `dingtalk_notifier.py`: 钉钉通知器核心模块
- `enhanced_trader.py`: 集成了通知功能的交易器
- `online_strategy_engine.py`: 策略引擎
- `start_online_trading.py`: 系统启动器

### 集成点
通知功能已集成到以下关键操作：
- ✅ 开仓操作 (`open_position`)
- ✅ 平仓操作 (`close_position`) 
- ✅ 挂单操作 (`place_golden_ratio_order`)
- ✅ 挂单状态检查 (`check_pending_orders`)
- ✅ 风险管理 (`check_risk_management`)

### 自动关键词处理
系统会自动在消息中添加 "Code" 关键词以满足钉钉机器人要求，无需手动处理。

## 🧪 测试功能

可以使用以下命令测试钉钉通知功能：

```bash
# 测试所有通知类型
python3 test_dingtalk_notification.py

# 测试关键词（如需要）
python3 test_dingtalk_keywords.py
```

## ⚠️ 注意事项

1. **频率限制**: 钉钉机器人有发送频率限制，避免短时间内发送过多消息
2. **网络连接**: 确保服务器能正常访问钉钉API
3. **关键词要求**: 必须包含 "Code" 关键词，系统已自动处理
4. **错误处理**: 通知发送失败不会影响交易逻辑的正常执行

## 🔄 自定义配置

如需自定义通知内容或添加新的通知类型，可以：

1. 修改 `dingtalk_notifier.py` 中的通知模板
2. 在 `enhanced_trader.py` 中添加新的通知调用点
3. 更新关键词列表以适应不同的机器人配置

## 📞 支持

如有问题，请检查：
1. Webhook地址是否正确
2. 网络连接是否正常
3. 钉钉机器人是否配置正确
4. 关键词是否匹配
