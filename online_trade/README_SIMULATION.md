# 模拟交易功能使用说明

## 🎮 功能概述

在线交易系统现已支持模拟交易模式，让你可以在不使用真实资金的情况下测试策略、验证系统功能，并通过钉钉接收所有交易通知。

## ⚙️ 配置说明

### 1. 配置文件设置

在 `online_data/config/config.json` 中：

```json
{
  "trading": {
    "enable_real_trading": false,  // false=模拟模式，true=真实交易
    "initial_capital": 1000,       // 模拟初始资金
    // ... 其他配置
  }
}
```

### 2. 命令行启动

```bash
# 模拟交易模式（默认）
python3 start_online_trading.py

# 明确指定模拟模式
python3 start_online_trading.py --disable-real-trading

# 启用真实交易模式
python3 start_online_trading.py --enable-real-trading

# 模拟模式 + 自定义资金
python3 start_online_trading.py --capital 5000
```

## 🎯 功能特性

### ✅ 支持的操作

1. **模拟开仓**
   - 模拟市价买入和限价买入
   - 自动计算滑点（0.1%）
   - 更新模拟账户余额
   - 创建虚拟持仓

2. **模拟平仓**
   - 模拟市价卖出和限价卖出
   - 计算盈亏和持仓时长
   - 更新模拟账户余额
   - 发送盈亏通知

3. **模拟挂单**
   - 创建虚拟黄金分割点挂单
   - 超时自动取消
   - 手动取消挂单
   - 挂单状态管理

4. **完整通知**
   - 所有交易操作都发送钉钉通知
   - 通知中明确标识为"模拟交易"
   - 与真实交易通知格式一致

### 🔍 信号计算

- ✅ 完整的信号检测和计算
- ✅ 成交量突破策略运行
- ✅ 技术指标分析
- ✅ 风险管理逻辑

### 📊 投资组合管理

- ✅ 模拟账户余额管理
- ✅ 虚拟持仓跟踪
- ✅ 盈亏计算和统计
- ✅ 风险监控和控制

## 📱 通知示例

### 模拟开仓通知
```
🎮 开仓通知

交易模式: 模拟交易
交易对: BTCUSDT
开仓时间: 2024-09-14 15:30:25
开仓价格: $65432.10
开仓数量: 0.001523
投资金额: $99.65
策略类型: volume_breakout
信号强度: 7.5

开仓理由: 成交量突破信号，信号强度7.5，使用模拟市价单
```

### 模拟平仓通知
```
🎮🎉 平仓通知

交易模式: 模拟交易
交易对: BTCUSDT
平仓时间: 2024-09-14 18:45:30
平仓价格: $67123.45
平仓数量: 0.001523
平仓收入: $102.24
原始成本: $99.65
盈亏金额: +$2.59
盈亏比例: +2.6%
持仓时长: 3.2小时

平仓原因: 移动止盈 (2.6%)
```

## 🚀 使用场景

### 1. 策略验证
```bash
# 验证策略逻辑
python3 start_online_trading.py --strategy-only --capital 10000
```

### 2. 系统测试
```bash
# 测试完整系统
python3 start_online_trading.py --capital 1000
```

### 3. 功能测试
```bash
# 运行专门的测试脚本
python3 test_simulation_mode.py
```

## 📈 模拟交易流程

### 开仓流程
1. 检测到交易信号
2. 计算仓位大小
3. 执行模拟买入
4. 更新模拟余额
5. 创建虚拟持仓
6. 发送钉钉通知

### 平仓流程
1. 触发平仓条件（止盈/止损/时间退出）
2. 执行模拟卖出
3. 计算盈亏
4. 更新模拟余额
5. 删除虚拟持仓
6. 发送钉钉通知

### 挂单流程
1. 计算黄金分割点价格
2. 创建虚拟挂单
3. 监控挂单状态
4. 超时自动取消
5. 发送相关通知

## 🔧 技术实现

### 核心组件
- `simulate_buy()`: 模拟买入方法
- `simulate_sell()`: 模拟卖出方法
- `simulated_usdt_balance`: 模拟余额管理
- `simulated_positions`: 虚拟持仓跟踪

### 数据管理
- 所有模拟订单ID以 `SIM_` 开头
- 交易历史完整记录
- 持仓数据实时更新
- 余额变化准确计算

## ⚠️ 注意事项

### 模拟vs真实差异
1. **滑点模拟**: 使用固定0.1%滑点，实际可能不同
2. **订单成交**: 模拟订单100%成交，实际可能部分成交或不成交
3. **市场深度**: 不考虑真实市场深度限制
4. **网络延迟**: 不包含网络延迟和API限制

### 切换到真实交易
1. 修改配置文件 `enable_real_trading: true`
2. 或使用命令行参数 `--enable-real-trading`
3. 确保API密钥配置正确
4. 检查账户余额充足

### 安全提醒
- 模拟模式下不会产生任何真实交易
- 所有资金变化都是虚拟的
- 可以安全测试任何策略参数
- 建议先在模拟模式下验证策略

## 📊 测试结果示例

运行 `python3 test_simulation_mode.py` 的示例输出：

```
🎮 开始测试模拟交易模式...
============================================================
🚀 增强版交易器初始化完成
   交易模式: 🎮 模拟交易
   初始资金: $1,000

📊 初始状态:
   交易模式: simulation
   模拟余额: $1000.00
   持仓数量: 0

🔄 测试1: 模拟开仓...
✅ BTCUSDT 模拟开仓成功

📊 开仓后状态:
   模拟余额: $925.00
   持仓价值: $74.93
   总资产: $999.93
   仓位占比: 7.49%

🔄 测试2: 模拟平仓...
✅ BTCUSDT 模拟平仓成功

🎉 模拟交易模式测试完成！
```

## 🎯 总结

模拟交易模式提供了：
- ✅ 完整的策略验证环境
- ✅ 真实的交易流程体验
- ✅ 安全的测试环境
- ✅ 完整的通知和监控
- ✅ 准确的盈亏计算

这让你可以在正式上线前充分测试和优化你的交易策略！
